3.3.	Xây dựng các dịch vụ:
3.3.1.	UserService:
3.3.1.1.	Tổng quan:
Trong kiến trúc Microservices, UserService đóng vai trò quản lý toàn bộ vòng đời người dùng, bao gồm đăng ký, đăng nhập, cập nhật thông tin cá nhân, xác thực và phân quyền. Dịch vụ được xây dựng trên nền tảng Node.js với Express framework, sử dụng MongoDB làm cơ sở dữ liệu để lưu trữ thông tin người dùng.
Công nghệ triển khai bao gồm Passport.js hỗ trợ xác thực OAuth 2.0 với Google và Facebook, JWT (JSON Web Token) cho cơ chế Access Token và Refresh Token, Nodemailer để gửi email xác thực, và bcrypt mã hóa mật khẩu. Dịch vụ chạy trên cổng 3005 và kết nối với cơ sở dữ liệu userserviceDB.
Một số thách thức kỹ thuật nổi bật trong quá trình triển khai dịch vụ này bao gồm việc đảm bảo tính duy nhất và toàn vẹn dữ liệu (đối với các thông tin định danh như email hoặc username), duy trì bảo mật khi lưu trữ và truy xuất thông tin, cũng như triển khai cơ chế phân quyền hiệu quả trong môi trường phân tán.
Để giải quyết các vấn đề trên, UserService được xây dựng như một dịch vụ độc lập, cung cấp bộ API RESTful để phục vụ các thao tác quản lý người dùng. Dữ liệu được lưu trữ trong MongoDB với các index unique cho email và username, đảm bảo khả năng truy vấn hiệu quả và duy trì tính toàn vẹn dữ liệu. Dịch vụ được tích hợp với API Gateway để định tuyến và bảo mật.
Với vai trò là một trong những dịch vụ trung tâm của hệ thống, UserService không chỉ quản lý hồ sơ người dùng mà còn cung cấp dữ liệu đầu vào thiết yếu cho các dịch vụ khác như CartService, OrderService, PaymentService và ReviewService. Nhờ đó, dịch vụ đóng vai trò nền tảng cho việc cá nhân hóa trải nghiệm mua sắm và duy trì tính liên kết thống nhất trong toàn bộ hệ thống thương mại điện tử.
3.3.1.2.	Cách thức triển khai:
a)	 Đăng ký tài khoản
 
Hình 3. 12 Sơ đồ hoạt động đăng ký tài khoản
Người dùng bắt đầu bằng cách điền form đăng ký với các thông tin cần thiết như email, tên đăng nhập, mật khẩu, họ tên . Hệ thống tiến hành kiểm tra tính hợp lệ của dữ liệu đầu vào, bao gồm định dạng email, độ dài và độ phức tạp của mật khẩu, cũng như tính duy nhất của email và username trong cơ sở dữ liệu.
Sau khi validation thành công, mật khẩu được mã hóa bằng thuật toán bcrypt với salt rounds là 10 để đảm bảo an toàn. Hệ thống tạo mã OTP gồm 6 chữ số ngẫu nhiên và thiết lập thời gian hết hạn là 5 phút. Thông tin người dùng mới cùng với OTP được lưu vào MongoDB với trạng thái email chưa xác thực.
Email chứa mã OTP được gửi đến địa chỉ email đăng ký thông qua Nodemailer. Email này có giao diện chuyên nghiệp với logo SmartBuy, mã OTP hiển thị rõ ràng và hướng dẫn xác thực tài khoản. Người dùng nhận được thông báo đăng ký thành công và được yêu cầu kiểm tra email để hoàn tất xác thực tài khoản trong vòng 5 phút.
b)	 Đăng nhập với Email/Password
Quy trình đăng nhập bắt đầu khi người dùng cung cấp email hoặc username cùng với mật khẩu. Hệ thống tìm kiếm người dùng trong cơ sở dữ liệu MongoDB dựa trên thông tin đăng nhập được cung cấp. Truy vấn sử dụng toán tử OR để cho phép đăng nhập bằng cả email hoặc username.
Nếu tìm thấy người dùng, hệ thống kiểm tra trạng thái xác thực email. Chỉ những tài khoản đã xác thực email mới được phép đăng nhập để đảm bảo tính xác thực của người dùng. Tiếp theo, mật khẩu được so sánh với mật khẩu đã mã hóa trong cơ sở dữ liệu sử dụng phương thức compare của bcrypt.
Khi xác thực thành công, hệ thống tạo hai loại token JWT. Access Token có thời gian sống 15 phút chứa thông tin userId, email và role trong payload. Token này được sử dụng để xác thực các request tiếp theo. Refresh Token có thời gian sống 7 ngày được lưu vào cơ sở dữ liệu trong trường refreshToken của user document và gửi về client qua httpOnly cookie để tăng cường bảo mật, ngăn chặn tấn công XSS.
Access Token được trả về trong response body cùng với thông tin người dùng bao gồm id, email, username, họ tên, avatar và role nhưng không bao gồm mật khẩu. Client lưu trữ Access Token trong localStorage hoặc memory và sử dụng cho các request tiếp theo thông qua Authorization header.
Khi Access Token hết hạn sau 15 phút, client sử dụng Refresh Token để lấy Access Token mới mà không cần người dùng đăng nhập lại. Cơ chế này giúp cân bằng giữa bảo mật và trải nghiệm người dùng.

c)	Người dùng đăng nhập thông qua tài khoản Google hoặc Facebook:

 
Hình 3. 13 Sơ đồ hoạt động đăng nhập bằng Google/Facebook
Hệ thống hỗ trợ đăng nhập nhanh thông qua tài khoản Google hoặc Facebook sử dụng Passport.js. Khi người dùng chọn đăng nhập bằng Google, họ được chuyển hướng đến trang xác thực của Google. Tại đây, Google yêu cầu người dùng đăng nhập (nếu chưa) và cấp quyền truy cập thông tin cơ bản như tên, email và ảnh đại diện cho ứng dụng SmartBuy.
Sau khi người dùng đồng ý cấp quyền, Google gửi thông tin profile về hệ thống thông qua callback URL đã đăng ký. Hệ thống nhận được profile chứa Google ID, email, tên và ảnh đại diện. Hệ thống kiểm tra xem người dùng đã tồn tại trong cơ sở dữ liệu dựa trên Google ID hoặc email.
Nếu tìm thấy user với Google ID khớp, hệ thống cho phép đăng nhập ngay lập tức. Nếu không tìm thấy Google ID nhưng tìm thấy email khớp, hệ thống liên kết Google ID với tài khoản hiện có để người dùng có thể đăng nhập bằng cả hai phương thức trong tương lai. Nếu hoàn toàn không tìm thấy, hệ thống tự động tạo tài khoản mới với thông tin từ Google profile, đánh dấu email đã xác thực và gán vai trò mặc định là không phải isAdmin= “false” .
Quy trình tương tự áp dụng cho đăng nhập Facebook, sử dụng Facebook App ID và App Secret. Facebook Strategy của Passport.js xử lý OAuth flow tương tự Google. Sau khi xác thực thành công qua OAuth, hệ thống tạo Access Token và Refresh Token tương tự như đăng nhập thường và trả về cho client.
Ưu điểm của OAuth là người dùng không cần nhớ thêm mật khẩu, quá trình đăng ký nhanh chóng chỉ một click, và tận dụng được security của Google/Facebook. Nhược điểm là phụ thuộc vào dịch vụ bên thứ ba và cần cấu hình OAuth credentials cẩn thận.
d)	Quản lý danh sách yêu thích
Chức năng danh sách yêu thích (wishlist) cho phép người dùng lưu trữ các sản phẩm điện thoại mà họ quan tâm để xem lại hoặc mua sau. Khi người dùng duyệt qua các sản phẩm trên hệ thống, họ có thể đánh dấu những sản phẩm ưa thích bằng cách thêm vào danh sách yêu thích. Các sản phẩm trong danh sách này được lưu trữ gắn liền với tài khoản người dùng, cho phép truy cập từ bất kỳ thiết bị nào mà họ đăng nhập.
Quá trình thêm sản phẩm vào danh sách yêu thích được thiết kế đơn giản và trực quan. Người dùng chỉ cần nhấn vào biểu tượng trái tim hoặc nút yêu thích trên trang sản phẩm, hệ thống sẽ kiểm tra xác thực người dùng và lưu thông tin sản phẩm vào danh sách cá nhân. Nếu sản phẩm đã có trong danh sách, hệ thống sẽ thông báo để tránh trùng lặp. Ngược lại, người dùng cũng có thể xóa sản phẩm khỏi danh sách yêu thích bất cứ lúc nào bằng cách nhấn lại vào biểu tượng hoặc sử dụng chức năng xóa trong trang quản lý danh sách yêu thích.
Khi người dùng truy cập vào trang danh sách yêu thích, hệ thống sẽ hiển thị tất cả các sản phẩm đã lưu kèm theo thông tin chi tiết như hình ảnh, tên sản phẩm, giá hiện tại, đánh giá và trạng thái còn hàng. Điều này giúp người dùng dễ dàng so sánh các sản phẩm yêu thích và đưa ra quyết định mua sắm. Từ danh sách này, người dùng có thể nhanh chóng thêm sản phẩm vào giỏ hàng mà không cần phải tìm kiếm lại, tối ưu hóa trải nghiệm mua sắm và tiết kiệm thời gian.
e)	Xem lịch sử mua hàng
Lịch sử mua hàng là tính năng quan trọng giúp người dùng theo dõi tất cả đơn hàng đã đặt, xem lại thông tin sản phẩm đã mua và quản lý các giao dịch một cách hiệu quả. Khi truy cập vào trang lịch sử đơn hàng, người dùng có thể xem danh sách các đơn hàng được sắp xếp theo thứ tự thời gian, từ mới nhất đến cũ nhất. Mỗi đơn hàng hiển thị các thông tin cơ bản như mã đơn hàng, ngày đặt, tổng giá trị, trạng thái hiện tại và hình ảnh đại diện của sản phẩm.
Hệ thống cung cấp nhiều tùy chọn lọc và sắp xếp để người dùng dễ dàng tìm kiếm đơn hàng cụ thể. Người dùng có thể lọc đơn hàng theo trạng thái (chờ xác nhận, đang giao, hoàn thành, đã hủy), theo khoảng thời gian đặt hàng, theo phương thức thanh toán (tiền mặt hoặc VNPay), hoặc theo khoảng giá trị đơn hàng. Các tùy chọn sắp xếp bao gồm mới nhất, cũ nhất, giá trị cao nhất và giá trị thấp nhất, giúp người dùng nhanh chóng tìm thấy thông tin mong muốn.
Ngoài danh sách tổng quan, hệ thống còn hiển thị các thống kê tóm tắt như tổng số đơn hàng đã đặt, tổng số tiền đã chi tiêu và số lượng đơn hàng theo từng trạng thái. Thông tin này giúp người dùng có cái nhìn tổng quát về hoạt động mua sắm của mình. Từ danh sách lịch sử, người dùng có thể click vào từng đơn hàng để xem chi tiết đầy đủ, bao gồm thông tin sản phẩm, địa chỉ giao hàng, phương thức thanh toán và các trạng thái đơn hàng đã trải qua.
Hệ thống cũng cung cấp các chức năng tiện ích như mua lại đơn hàng cũ (tự động thêm các sản phẩm từ đơn hàng trước vào giỏ hàng hiện tại sau khi kiểm tra tồn kho), theo dõi đơn hàng đang vận chuyển với thông tin realtime, và tải xuất hóa đơn điện tử cho các đơn hàng đã hoàn thành. Những tính năng này không chỉ nâng cao trải nghiệm người dùng mà còn giúp họ quản lý chi tiêu và lưu trữ chứng từ một cách khoa học.

f)	Quản lý địa chỉ giao hàng
Hệ thống cho phép người dùng lưu trữ nhiều địa chỉ giao hàng khác nhau để phục vụ cho các giao dịch mua sắm. Mỗi địa chỉ bao gồm đầy đủ thông tin như tên người nhận, số điện thoại liên hệ, tỉnh/thành phố, quận/huyện, phường/xã, địa chỉ cụ thể (số nhà, tên đường), loại địa chỉ (nhà riêng, văn phòng, khác) và có thể được đánh dấu làm địa chỉ mặc định. Việc lưu trữ nhiều địa chỉ giúp người dùng linh hoạt trong việc chọn điểm giao hàng phù hợp với từng lần mua sắm.
Khi thêm địa chỉ mới, người dùng điền đầy đủ thông tin vào biểu mẫu được cung cấp. Hệ thống sẽ xác thực tính hợp lệ của các trường thông tin, đảm bảo không có dữ liệu thiếu hoặc sai định dạng trước khi lưu vào cơ sở dữ liệu. Nếu người dùng chọn đặt địa chỉ mới làm mặc định, hệ thống tự động gỡ bỏ cờ mặc định của các địa chỉ khác để đảm bảo chỉ có một địa chỉ mặc định duy nhất tại một thời điểm. Địa chỉ mặc định sẽ được tự động điền vào thông tin giao hàng khi người dùng thực hiện đặt hàng, giúp rút ngắn thời gian thanh toán.
Người dùng có thể cập nhật thông tin của các địa chỉ đã lưu bất cứ lúc nào, bao gồm thay đổi tên người nhận, số điện thoại, hoặc các thông tin địa chỉ khác. Hệ thống also cho phép xóa các địa chỉ không còn sử dụng, giúp danh sách địa chỉ luôn được ngăn nắp và dễ quản lý. Khi truy xuất danh sách địa chỉ, hệ thống sắp xếp với địa chỉ mặc định hiển thị ở vị trí đầu tiên để thuận tiện cho việc chọn lựa.

3.3.2.	ProductService 
3.3.2.1.	Tổng quan:
ProductService và Product ManagerService đóng vai trò trung tâm trong việc quản lý dữ liệu sản phẩm điện thoại di động của hệ thống SmartBuy, tích hợp đa dạng chức năng từ phân loại, định danh đến triển khai chiến lược kinh doanh. Dịch vụ này không chỉ tối ưu hóa trải nghiệm người dùng thông qua việc tìm kiếm thông minh, lọc đa tiêu chí (màu sắc, bộ nhớ, giá cả) và hiển thị thông tin chi tiết, mà còn hỗ trợ doanh nghiệp trong việc kiểm soát hàng hóa, quản lý khuyến mãi và phân tích dữ liệu.
Với khả năng quản lý danh mục linh hoạt, ProductService cho phép phân nhóm sản phẩm điện thoại theo đặc tính như iPhone, Samsung Galaxy, Xiaomi, kèm hình ảnh minh họa và mô tả chi tiết. Hệ thống biến thể màu sắc và bộ nhớ được chuẩn hóa, giúp đồng bộ tồn kho theo thời gian thực và cá nhân hóa lựa chọn cho khách hàng. Đặc biệt, tính năng khuyến mãi tự động áp dụng ưu đãi cao nhất trên sản phẩm, kết hợp với cơ chế phân trang, cache dữ liệu, đảm bảo tốc độ xử lý ngay cả với lượng truy vấn lớn.
Kết hợp giữa tính linh hoạt trong vận hành và độ chính xác trong quản lý, ProductService trở thành nền tảng không thể thiếu để duy trì tính cạnh tranh và phát triển bền vững cho nền tảng thương mại điện tử SmartBuy.
3.3.2.2.	Các chức năng:
a)	Quản lý danh mục sản phẩm
 

Hình 3. 14 Sơ đồ hoạt động quản lý sản phẩm
Trong hệ thống, chức năng quản lý danh mục của admin đóng vai trò quan trọng trong việc phân loại và gán nhãn cho các sản phẩm điện thoại, giúp tối ưu hóa quá trình tìm kiếm và lọc sản phẩm của người dùng. Quản trị viên có thể tạo ra các danh mục sản phẩm mới như "iPhone", "Samsung", "Xiaomi", "OPPO" để phân loại sản phẩm theo thương hiệu hoặc phân khúc giá. Quá trình tạo danh mục bao gồm việc nhập tên danh mục, mã danh mục định danh duy nhất, mô tả chi tiết về đặc điểm của nhóm sản phẩm và đính kèm hình ảnh minh họa để thể hiện đặc trưng của từng danh mục.
Chức năng cập nhật danh mục của admin cho phép chỉnh sửa thông tin của các danh mục đã tồn tại, bao gồm việc thay đổi tên danh mục, mã danh mục, cập nhật mô tả và thay đổi hình ảnh minh họa khi cần thiết. Việc cập nhật được thực hiện sau khi kiểm tra tính hợp lệ của dữ liệu, nhằm đảm bảo rằng thông tin danh mục luôn phản ánh chính xác và kịp thời những thay đổi trong chiến lược kinh doanh. Đối với các danh mục không còn phù hợp, hệ thống cung cấp chức năng vô hiệu hóa thay vì xóa hoàn toàn. Cơ chế này giúp giữ lại lịch sử dữ liệu và ngăn chặn việc hiển thị các danh mục không còn hoạt động cho người dùng cuối, góp phần nâng cao hiệu quả quản lý sản phẩm và tối ưu hóa trải nghiệm mua sắm.
Hệ thống hỗ trợ truy xuất danh sách danh mục với khả năng phân trang và sắp xếp theo các tiêu chí khác nhau, giúp người dùng và quản trị viên dễ dàng duyệt qua số lượng lớn danh mục một cách mạch lạc. Chức năng truy xuất chi tiết danh mục cung cấp thông tin đầy đủ về một danh mục cụ thể, bao gồm tên, mã, mô tả và hình ảnh minh họa, hỗ trợ việc kiểm tra và quản lý danh mục một cách hiệu quả.
b) Quản lý màu sắc và bộ nhớ
Chức năng quản lý màu sắc được thiết kế để lưu trữ và phân loại thông tin về các màu sắc điện thoại có sẵn trong hệ thống. Quản trị viên có thể tạo mới các giá trị màu sắc như "Titan Tự Nhiên", "Titan Đen", "Titan Trắng", "Titan Sa Mạc" cho dòng iPhone hoặc "Xanh Dương", "Đen Bóng Đêm" cho Samsung. Quá trình tạo màu sắc bao gồm việc nhập tên màu, mã định danh màu, mã màu theo chuẩn HEX và mô tả chi tiết. Hệ thống kiểm tra tính duy nhất của các trường thông tin trước khi lưu trữ để đảm bảo không có sự trùng lặp.
Tương tự, chức năng quản lý bộ nhớ cho phép quản trị viên tổ chức và kiểm soát thông tin về các tùy chọn dung lượng như 64GB, 128GB, 256GB, 512GB và 1TB. Mỗi tùy chọn bộ nhớ được định nghĩa bằng tên và mã định danh duy nhất. Việc chuẩn hóa thông tin về màu sắc và bộ nhớ giúp hệ thống quản lý biến thể sản phẩm một cách nhất quán, hỗ trợ người dùng trong việc tìm kiếm và lựa chọn sản phẩm theo đúng nhu cầu.
Hệ thống cung cấp các chức năng cập nhật để chỉnh sửa thông tin màu sắc và bộ nhớ đã tạo, vô hiệu hóa các giá trị không còn sử dụng thay vì xóa hoàn toàn, cùng khả năng truy xuất danh sách với phân trang và sắp xếp. Điều này đảm bảo dữ liệu luôn được duy trì chính xác và phù hợp với thực tế kinh doanh.
c) Quản lý chương trình khuyến mãi
Chức năng quản lý chương trình khuyến mãi đóng vai trò chiến lược trong việc triển khai các chính sách giảm giá, giúp kích thích doanh số bán hàng và thu hút khách hàng. Quản trị viên có thể thiết lập các chương trình khuyến mãi mới bằng cách nhập tên chương trình, mã khuyến mãi định danh duy nhất, mô tả chi tiết về điều kiện áp dụng, tỷ lệ giảm giá theo phần trăm và khoảng thời gian có hiệu lực với ngày bắt đầu và ngày kết thúc rõ ràng.
Hệ thống tự động áp dụng chương trình khuyến mãi có tỷ lệ giảm giá cao nhất cho mỗi sản phẩm trong trường hợp có nhiều chương trình cùng áp dụng, đảm bảo khách hàng luôn nhận được ưu đãi tốt nhất. Chức năng cập nhật cho phép điều chỉnh thông tin khuyến mãi trong quá trình triển khai, bao gồm thay đổi tỷ lệ giảm giá hoặc gia hạn thời gian áp dụng. Đối với các chương trình đã hết hạn hoặc không còn phù hợp, chức năng vô hiệu hóa giúp chuyển trạng thái sang không hoạt động mà vẫn giữ lại dữ liệu phục vụ việc phân tích và báo cáo.
Quản trị viên có thể truy xuất danh sách các chương trình khuyến mãi với khả năng lọc theo trạng thái, thời gian và tỷ lệ giảm giá, giúp theo dõi hiệu quả của từng chiến dịch và đưa ra quyết định kinh doanh phù hợp.
d) Quản lý sản phẩm và biến thể
Chức năng quản lý sản phẩm là trung tâm của ProductService, cho phép lưu trữ và điều phối thông tin sản phẩm điện thoại một cách toàn diện. Mỗi sản phẩm được định nghĩa bằng tên sản phẩm (ví dụ "iPhone 15 Pro Max", "Samsung Galaxy S24 Ultra"), danh sách hình ảnh minh họa, mô tả chi tiết về tính năng kỹ thuật, và danh mục sản phẩm tương ứng.
Đặc biệt, hệ thống hỗ trợ quản lý biến thể sản phẩm theo hai chiều: màu sắc và bộ nhớ. Mỗi sản phẩm có thể có nhiều biến thể màu sắc, và mỗi màu sắc lại có thể có nhiều tùy chọn bộ nhớ khác nhau. Ví dụ, iPhone 15 Pro Max màu Titan Tự Nhiên có thể có các tùy chọn 256GB, 512GB và 1TB, mỗi tùy chọn có giá bán riêng. Cơ chế này đa dạng hóa lựa chọn cho khách hàng và giúp doanh nghiệp linh hoạt trong việc định giá theo từng biến thể.
Mỗi biến thể sản phẩm chứa thông tin về số lượng tồn kho và số lượng đã bán. Khi có đơn hàng được xác nhận, hệ thống tự động cập nhật giảm tồn kho và tăng số lượng đã bán, đảm bảo dữ liệu được đồng bộ theo thời gian thực. Điều này ngăn chặn tình trạng bán vượt quá số lượng hàng có sẵn và giúp quản lý kho hàng hiệu quả.
Quá trình tạo sản phẩm bắt đầu khi quản trị viên nhập thông tin cơ bản và tải lên hình ảnh sản phẩm. Các hình ảnh được chuyển đến dịch vụ lưu trữ đám mây để xử lý và trả về đường dẫn URL, sau đó được lưu cùng với thông tin sản phẩm. Tiếp theo, quản trị viên thêm các biến thể màu sắc kèm giá bán và chương trình khuyến mãi áp dụng, rồi thêm các tùy chọn bộ nhớ với số lượng tồn kho ban đầu. Tất cả thông tin được kiểm tra tính hợp lệ trước khi lưu vào cơ sở dữ liệu.
Chức năng cập nhật sản phẩm cho phép chỉnh sửa toàn bộ thông tin đã lưu, bao gồm thay đổi hình ảnh, điều chỉnh giá bán, cập nhật mô tả, và quản lý các biến thể. Đối với sản phẩm không còn kinh doanh, chức năng vô hiệu hóa chuyển trạng thái sang không hoạt động mà vẫn bảo toàn lịch sử giao dịch và đánh giá của khách hàng.
e) Truy xuất và hiển thị sản phẩm
Hệ thống cung cấp hai giao diện truy xuất sản phẩm khác nhau: một cho quản trị viên và một cho người dùng cuối. Giao diện quản trị hiển thị tất cả sản phẩm bao gồm cả những sản phẩm đã vô hiệu hóa, kèm theo chi tiết đầy đủ về chương trình khuyến mãi để hỗ trợ việc quản lý và ra quyết định kinh doanh. Danh sách được phân trang linh hoạt và hỗ trợ sắp xếp theo nhiều tiêu chí như tên sản phẩm, giá cả, danh mục và trạng thái tồn kho.
Giao diện người dùng chỉ hiển thị các sản phẩm đang hoạt động với khả năng tìm kiếm và lọc thông minh. Người dùng có thể tìm kiếm sản phẩm bằng từ khóa, lọc theo danh mục, khoảng giá, màu sắc hoặc bộ nhớ. Hệ thống hỗ trợ sắp xếp kết quả theo nhiều tiêu chí như sản phẩm bán chạy nhất (dựa vào số lượng đã bán), sản phẩm mới nhất, sản phẩm có giảm giá cao nhất, giá tăng dần hoặc giảm dần. Các bộ lọc và sắp xếp này giúp người dùng nhanh chóng tìm thấy sản phẩm phù hợp với nhu cầu.
Chức năng truy xuất chi tiết sản phẩm cung cấp thông tin toàn diện về một sản phẩm cụ thể, bao gồm tất cả hình ảnh, mô tả đầy đủ, các biến thể màu sắc và bộ nhớ có sẵn với giá và tồn kho tương ứng, chương trình khuyến mãi hiện hành, và các đánh giá từ khách hàng đã mua. Hệ thống tự động áp dụng chương trình khuyến mãi có ưu đãi cao nhất, tính toán giá sau giảm và hiển thị rõ ràng cho người dùng, kích thích quyết định mua hàng thông qua giá cả hấp dẫn.
Để đảm bảo hiệu suất khi xử lý lượng truy vấn lớn, hệ thống áp dụng cơ chế cache dữ liệu, lưu trữ tạm các kết quả truy vấn phổ biến và giảm tải áp lực lên cơ sở dữ liệu. Cơ chế phân trang thông minh giúp tải dữ liệu theo từng trang nhỏ thay vì tải toàn bộ, tối ưu hóa tốc độ phản hồi và trải nghiệm người dùng.
3.3.2.3. Tổng kết
ProductService đóng vai trò nền tảng trong việc quản lý thông tin sản phẩm điện thoại và hỗ trợ trải nghiệm mua sắm toàn diện cho khách hàng. Thông qua các chức năng quản lý danh mục, màu sắc, bộ nhớ, khuyến mãi và biến thể sản phẩm, hệ thống đảm bảo dữ liệu được tổ chức khoa học và dễ dàng truy xuất. Khả năng tìm kiếm thông minh, lọc đa tiêu chí và hiển thị thông tin chi tiết giúp người dùng nhanh chóng tìm thấy sản phẩm phù hợp, trong khi các chức năng quản lý mạnh mẽ hỗ trợ doanh nghiệp vận hành hiệu quả và triển khai chiến lược kinh doanh linh hoạt.
3.3.3.	OrderService và PaymentService
3.3.3.1. Tổng quan
OrderService và PaymentService là hai thành phần then chốt hoạt động phối hợp chặt chẽ trong hệ thống SmartBuy, cùng nhau quản lý toàn bộ quá trình giao dịch mua bán điện thoại từ khâu tạo đơn hàng, xử lý thanh toán, cho đến hoàn tất hoặc hủy giao dịch. Sự tích hợp liên kết giữa hai services này đảm bảo tính toàn vẹn dữ liệu, đồng bộ trạng thái thời gian thực và mang lại trải nghiệm mua sắm mượt mà cho khách hàng.
OrderService chịu trách nhiệm quản lý vòng đời đơn hàng theo các luồng trạng thái được định nghĩa rõ ràng. Các trạng thái bao gồm: "Chờ thanh toán" cho đơn VNPay chưa thanh toán, "Thanh toán thất bại"  khi thanh toán online không thành công, "Chờ xác nhận") cho đơn COD mới tạo, "Đã xác nhận" khi shop chấp nhận đơn, "Đang chuẩn bị" , "Sẵn sàng giao", "Đang giao hàng" , "Đã giao hàng" , "Hoàn thành" , "Đã hủy"  và "Đã trả hàng" . Mỗi thay đổi trạng thái được lưu vào lịch sử  với các mốc thời gian, ghi chú, đảm bảo khả năng truy vết đầy đủ.
PaymentService đảm nhận vai trò xử lý thanh toán cho đơn hàng, hỗ trợ hai phương thức chính: COD (Cash on Delivery - thanh toán khi nhận hàng) và VNPay (cổng thanh toán online qua ví điện tử). Service được thiết kế với cơ chế bảo mật cao, sử dụng HMAC SHA512 để xác thực chữ ký từ VNPay gateway, ngăn chặn gian lận và đảm bảo tính toàn vẹn dữ liệu giao dịch. Mỗi Giao dịch thanh toán được lưu trữ chi tiết trong MongoDB với đầy đủ thông tin: order liên kết, số tiền, phương thức, trạng thái (pending, paid, failed, refunded), mã giao dịch VNPay, trả về từ gateway.
3.3.3.2. Cách thức triển khai
a) Tạo đơn hàng và khởi tạo thanh toán
Quá trình tạo đơn hàng bắt đầu khi khách hàng ở trang giỏ hàng và quyết định tiến hành thanh toán. Hệ thống tải thông tin giỏ hàng đã chứa các biến thể sản phẩm về màu sắc, cấu hình, đảm bảo tất cả sản phẩm đều còn hàng và số lượng hợp lệ. Người dùng được chuyển đến trang thanh toán nơi họ có thể nhập hoặc chọn địa chỉ giao hàng từ danh sách đã lưu, và chọn phương thức thanh toán giữa COD (thanh toán khi nhận hàng) và VNPay (thanh toán online qua ví điện tử). Hệ thống tính toán chi phí đơn hàng một cách chi tiết, bao gồm tổng giá trị sản phẩm  được tính bằng cách cộng giá nhân số lượng của các sản phẩm đã chọn trong giỏ, phí vận chuyển cố định. Tổng giá trị cuối cùng (total price) là tổng các khoản trên. Thông tin chi phí được hiển thị rõ ràng để người dùng kiểm tra trước khi xác nhận. Khi người dùng nhấn nút đặt hàng, hệ thống thực hiện một loạt kiểm tra cuối cùng. Địa chỉ giao hàng phải được chọn đầy đủ và hợp lệ. Tồn kho của tất cả sản phẩm được kiểm tra lần nữa để đảm bảo vẫn đủ số lượng, vì có thể trong thời gian người dùng checkout, người khác đã mua hết. Nếu bất kỳ item nào không đủ hàng, hệ thống thông báo lỗi chi tiết và yêu cầu người dùng cập nhật giỏ hàng trước khi thử lại.
 
Hình 3. 15 Sơ đồ hoạt động tạo đơn hàng
Nếu tất cả điều thông qua, hệ thống tạo đơn hàng mới với mã đơn hàng duy nhất được tự động theo format dễ nhận biết. Đơn hàng lưu trữ đầy đủ thông tin sản phẩm tại thời điểm mua, bao gồm tên, hình ảnh, màu sắc, bộ nhớ, giá tại thời điểm đặt hàng và số lượng. Với phương thức thanh toán COD, đơn hàng được tạo với trạng thái "pending" (chờ shop xác nhận) và paymentStatus là "pending" (sẽ thu tiền khi giao). Ngay sau khi tạo xong, hệ thống sẽ gửi email xác nhận đơn hàng cho khách, chứa thông tin chi tiết về sản phẩm đã đặt, địa chỉ giao hàng, tổng tiền và thời gian dự kiến giao. Giỏ hàng của người dùng được xóa sạch để chuẩn bị cho lần mua tiếp theo. Người dùng được chuyển hướng  đến trang "Đặt hàng thành công" với thông tin đơn và hướng dẫn theo dõi.
Với phương thức VNPay, đơn hàng được tạo với trạng thái "pending" (chờ thanh toán online). Hệ thống gọi PaymentService để tạo ra các dữ liệu cần thiết cho giao dịch như, giá tiền, mã giao sản phẩm , ngày mua và nhận URL thanh toán từ cổng VNPay. Người dùng được chuyển hướng đến trang thanh toán VNPay nơi họ có thể quét mã QR, nhập thông tin ngân hàng hoặc chọn các hình thức khác để hoàn tất thanh toán. Khi thanh toán hoàn tất, VNPay gọi callback về hệ thống. Nếu callback báo thanh toán thành công, PaymentService thông báo cho OrderService cập nhật đơn hàng: paymentStatus chuyển sang "paid" (đã thanh toán). Hệ thống trừ tồn kho sản phẩm, gửi email xác nhận thanh toán thành công. Người dùng thấy trang "Thanh toán thành công" với thông tin đơn hàng. Nếu thanh toán thất bại, PaymentService thông báo OrderService cập nhật trang thái cho đơn hàng là “Thanh toán thất bại”. Người dùng phải hủy đơn và tạo mới đơn hàng khác .
b) Theo dõi đơn hàng
Khách hàng có thể xem tất cả đơn hàng đã đặt thông qua trang lịch sử đơn hàng trong tài khoản cá nhân. Hệ thống lọc chỉ hiển thị đơn hàng của người dùng đang đăng nhập, sắp xếp theo thời gian tạo từ mới nhất đến cũ nhất. Mỗi đơn hàng hiển thị mã đơn, ngày đặt, giá tổng , trạng thái hiện tại với màu sắc phân biệt, ảnh đại diện sản phẩm và tổng số các sản phẩm đã mua. Người dùng có thể lọc đơn hàng theo nhiều tiêu chí. Lọc theo trạng thái cho phép xem riêng các đơn đang “chờ xác nhận, đang giao, hoàn thành hoặc đã hủy”. 
Thanh trạng thái hiển thị toàn bộ các trạng thái đơn hàng đã trải qua theo thứ tự thời gian, mỗi trạng thái có thời gian và có thể có ghi chú. Các trạng thái đã qua được đánh dấu hoàn thành, trạng thái hiện tại được tô màu sắc khác nhau. Thanh trạng thái giúp người dùng nắm rõ đơn hàng đang ở đâu trong quy trình. 
b)	Hủy đơn hàng
Người dùng được phép hủy đơn hàng trong một số trạng thái nhất định để đảm bảo tính linh hoạt. Trên trang chi tiết đơn hàng, nếu đơn đang ở trạng thái “Chờ xác nhận” hoặc  “Đã xác nhận”  nhưng chưa chuẩn bị,  nút "Hủy đơn" sẽ xuất hiện. Khi click, Trang sẽ hiển thị một khung cửa sổ yêu cầu chọn lý do hủy đơn với ô nhập lý do tự do. Nếu đơn đã chuyển sang "Chuẩn bị hàng" hoặc "Đang giao hàng", không cho phép tự hủy nữa và người dùng phải liên hệ support. Nếu hợp lệ, orderStatus chuyển sang "Đã hủy"  với thời gian hủy và lý do hủy được lưu.

 
Hình 3. 16 Sơ đồ hoạt động hủy đơn hàng của người dùng
Đối với đơn đã trừ tồn kho, khi hủy đơn hàng thì hệ thống gọi ProductService để hoàn trả tồn kho - cộng lại số lượng đã trừ vào tồn kho . Đối với đơn đã thanh toán qua VNPay, hệ thống sẽ hoàn tiền lại (có thể mất thời gian đối với hoàn tiền thực tế), và gửi mail thông báo cho khách hàng. Với đơn COD đã hủy trước khi thanh toán, không có vấn đề hoàn trả. Email thông báo hủy thành công được gửi với thông tin đơn hàng đã hủy. Đơn hàng vẫn được giữ trong lịch sử với trạng thái đã hủy để người dùng có thể đánh giá và có thể đặt lại nếu muốn.
3.3.3.3. Tổng kết
OrderService và PaymentService hợp tác chặt chẽ tạo nên công cụ giao dịch cốt lõi của SmartBuy. Thông qua kiến trúc liên kết lỏng lẻo với cơ chế gọi lại tự động, hai dịch vụ duy trì tính độc lập trong khi đảm bảo tính nhất quán dữ liệu qua đồng bộ hóa theo sự kiện. Vòng đời đơn hàng được quản lý nghiêm ngặt từ tạo, xử lý thanh toán, thực hiện đến hoàn thành hoặc hủy, với mỗi chuyển đổi trạng thái được kiểm toán đầy đủ, tích hợp liền mạch với thanh toán và thông báo qua mail cho khách hàng, và cung cấp khả năng theo dõi đơn hàng đầy đủ, OrderService đảm bảo trải nghiệm mua sắm suôn sẻ, minh bạch và tin cậy cho khách hàng. 
3.3.4.	CartService
3.3.4.1.	Tổng quan:
CartService đóng vai trò quan trọng trong việc quản lý giỏ hàng của người dùng trong hệ thống SmartBuy, cho phép lưu trữ tạm thời các sản phẩm điện thoại mà khách hàng quan tâm trước khi tiến hành đặt hàng. Dịch vụ này được thiết kế để cung cấp trải nghiệm mua sắm liền mạch, đảm bảo người dùng có thể quản lý giỏ hàng của mình một cách thuận tiện trên mọi thiết bị.Thiết kế giỏ hàng lưu trữ phía máy chủ mang lại nhiều lợi ích thiết yếu. Dữ liệu giỏ hàng được đồng bộ tự động giữa nhiều thiết bị , người dùng có thể thêm sản phẩm vào giỏ hàng trên máy tính để bàn, sau đó tiếp tục xem và thanh toán trên điện thoại di động mà không bị mất dữ liệu. Giỏ hàng được lưu trữ lâu dài gắn liền với tài khoản, không bị xóa khi đóng trình duyệt hay xóa bộ nhớ đệm. Hệ thống có thể kiểm tra số lượng tồn kho theo thời gian thực để tránh tình trạng khách hàng đặt hàng vượt quá số lượng có sẵn. CartService tích hợp chặt chẽ với ProductService để lấy thông tin sản phẩm và kiểm tra tồn kho, với UserService để quản lý quyền truy cập, và với OrderService để chuyển đổi giỏ hàng thành đơn hàng khi khách hàng tiến hành thanh toán. Sự tích hợp này tạo nên quy trình mua sắm hoàn chỉnh và nhất quán.




3.3.4.2. Cách thức triển khai
a) Thêm sản phẩm vào giỏ hàng
Chức năng thêm sản phẩm vào giỏ hàng được thiết kế để người dùng có thể dễ dàng lưu trữ các sản phẩm điện thoại mong muốn. Khi người dùng ở trang chi tiết sản phẩm và đã chọn màu sắc, bộ nhớ cũng như số lượng cần mua, hệ thống nhận yêu cầu thêm vào giỏ hàng. Trước tiên, hệ thống xác thực danh tính người dùng để đảm bảo chỉ người đã đăng nhập mới có thể sử dụng giỏ hàng.
 
Hình 3. 17 Sơ đồ hoạt động thêm sản phẩm vào giỏ hàng
Tiếp theo, hệ thống kiểm tra tính hợp lệ của thông tin sản phẩm và so sánh số lượng yêu cầu với tồn kho hiện tại. Hệ thống truy vấn để tìm biến thể sản phẩm cụ thể dựa vào sự kết hợp giữa sản phẩm, màu sắc và bộ nhớ được chọn. Số lượng tồn kho của biến thể này được kiểm tra và nếu số lượng yêu cầu vượt quá tồn kho, hệ thống thông báo lỗi chi tiết về số lượng còn lại và yêu cầu người dùng điều chỉnh. Nếu tồn kho đủ, hệ thống tìm kiếm giỏ hàng hiện tại của người dùng. Trường hợp chưa có giỏ hàng, một giỏ hàng mới sẽ được tạo và gắn với tài khoản người dùng.
Khi kiểm tra các sản phẩm trong giỏ hàng, nếu biến thể sản phẩm này đã tồn tại, hệ thống sẽ tự động cộng dồn số lượng mới vào số lượng hiện có thay vì tạo mục hàng trùng lặp. Nếu biến thể chưa có, một mục hàng mới sẽ được thêm vào giỏ hàng với thông tin chi tiết bao gồm tên sản phẩm, hình ảnh, màu sắc, bộ nhớ, giá tại thời điểm thêm vào và số lượng. Giá được lưu lại tại thời điểm này để đảm bảo rằng nếu giá sản phẩm thay đổi sau, giỏ hàng vẫn giữ nguyên giá đã hiển thị trước đó. Sau khi cập nhật danh sách các mục hàng, hệ thống tính toán lại tổng số lượng sản phẩm và tổng giá trị giỏ hàng, lưu trữ kết quả và thông báo thành công cho người dùng.
b) Cập nhật số lượng sản phẩm
Chức năng cập nhật số lượng sản phẩm trong giỏ hàng cho phép người dùng điều chỉnh số lượng của các mục hàng đã thêm. Khi người dùng thay đổi số lượng, hệ thống nhận mục hàng cần cập nhật và số lượng mới. Trước khi áp dụng thay đổi, hệ thống truy vấn lại thông tin tồn kho hiện tại của biến thể sản phẩm để đảm bảo số lượng mới không vượt quá khả năng cung ứng. Tồn kho có thể đã thay đổi do người dùng khác mua hoặc quản trị viên cập nhật, nên việc kiểm tra theo thời gian thực là cần thiết.
Nếu số lượng mới hợp lệ, hệ thống cập nhật mục hàng, tính toán lại tổng giá của mục hàng đó (giá nhân số lượng), rồi tính lại tổng giá trị và tổng số lượng của toàn bộ giỏ hàng. Người dùng nhận được phản hồi ngay lập tức về việc cập nhật thành công, đảm bảo trải nghiệm sử dụng mượt mà.
c) Xóa sản phẩm khỏi giỏ hàng
Chức năng xóa sản phẩm được kích hoạt khi người dùng quyết định không mua một sản phẩm cụ thể nữa. Hệ thống nhận yêu cầu với mục hàng cần xóa, xác thực quyền sở hữu giỏ hàng để đảm bảo chỉ chủ sở hữu mới có thể thay đổi, sau đó loại bỏ mục hàng khỏi danh sách. Tổng số lượng và tổng giá trị giỏ hàng được cập nhật lại để phản ánh chính xác tình trạng mới.
Nếu sau khi xóa, giỏ hàng trống hoàn toàn, hệ thống có thể hiển thị thông báo giỏ hàng rỗng kèm theo biểu tượng minh họa và gợi ý người dùng tiếp tục khám phá các sản phẩm khác trên trang web. Giao diện được thiết kế thân thiện để khuyến khích người dùng tiếp tục mua sắm.
3.3.4.3. Tổng kết
CartService là cầu nối quan trọng giữa giai đoạn duyệt sản phẩm và đặt hàng trong hành trình mua sắm của khách hàng. Thông qua các chức năng quản lý giỏ hàng linh hoạt, kiểm tra tồn kho theo thời gian thực và đồng bộ dữ liệu trên nhiều thiết bị, CartService mang lại trải nghiệm mua sắm thuận tiện và đáng tin cậy. Sự tích hợp chặt chẽ với ProductService để lấy thông tin sản phẩm và kiểm tra tồn kho, cùng với OrderService để chuyển đổi giỏ hàng thành đơn hàng, đảm bảo quy trình từ duyệt sản phẩm đến mua hàng diễn ra mượt mà. Kiến trúc này không chỉ góp phần nâng cao tỷ lệ chuyển đổi mà còn tăng cường sự hài lòng của khách hàng thông qua việc cung cấp thông tin chính xác và cập nhật liên tục về tình trạng sản phẩm và giỏ hàng.
3.3.5.	ReviewService:
3.3.5.1.	Tổng quan:
ReviewService là nơi quản lý toàn bộ phần đánh giá và bình luận sản phẩm trong hệ thống. Mục tiêu của dịch vụ là giúp khách hàng chia sẻ trải nghiệm (điểm số 1–5, nội dung, hình ảnh) và giúp cửa hàng kiểm duyệt, phản hồi kịp thời, từ đó tăng độ tin cậy và hỗ trợ ra quyết định mua hàng.
Về nghiệp vụ, ReviewService cho phép tạo, cập nhật, ẩn/hiện và xóa mềm bình luận; người dùng có thể đính kèm nhiều ảnh minh họa. Ở phía quản trị, dịch vụ hỗ trợ trả lời bình luận, chuyển trạng thái (hiển thị/ẩn, hoạt động/không hoạt động) và theo dõi số lượng bình luận chưa xử lý. Dữ liệu cốt lõi của mỗi đánh giá gồm: sản phẩm, người viết, điểm số, nội dung, ảnh đính kèm, thời gian tạo/cập nhật, trạng thái hiển thị và phần trả lời của admin.
Để trải nghiệm mượt hơn, ReviewService cung cấp cập nhật theo thời gian thực: khi có bình luận mới hoặc admin vừa trả lời, giao diện có thể nhận tín hiệu và hiển thị ngay mà không cần tải lại trang. Dịch vụ cũng tính điểm trung bình và phân bố đánh giá để dùng cho phần tóm tắt trên trang sản phẩm hoặc lọc/sắp xếp theo chất lượng.
Về dữ liệu và vận hành, các bản ghi đánh giá được lưu trong cơ sở dữ liệu tài liệu (MongoDB), xóa mềm để bảo toàn lịch sử và đối soát khi cần. Dịch vụ ghi log rõ ràng, kiểm tra tính hợp lệ (điểm số 1–5, trạng thái), và hỗ trợ theo dõi sức khỏe/hiệu năng phục vụ giám sát. Khi tích hợp với các phần khác, ReviewService cung cấp số liệu tóm tắt để hiển thị nhanh (ví dụ tổng số đánh giá, điểm trung bình), còn phần chi tiết (danh sách bình luận, ảnh) được tải khi người dùng cần xem sâu hơn.
Tóm lại, ReviewService giúp tạo một vòng phản hồi minh bạch giữa khách hàng và cửa hàng: người mua dễ bày tỏ ý kiến, người quản trị dễ kiểm duyệt và phản hồi, trang sản phẩm có thêm minh chứng và đánh giá rõ ràng, cập nhật kịp thời.
 
3.3.5.2.	Chức năng đánh giá sản phẩm:
a)	User thêm đánh giá:
 
Hình 3. 18 Sơ đồ hoạt động người đùng đánh giá sản phẩm
Ở phía người dùng, chức năng đánh giá sản phẩm mang đến trải nghiệm chia sẻ ý kiến một cách tự nhiên và dễ dàng. Ngay trên trang sản phẩm, khách hàng có thể để lại lời nhận xét, chọn số sao đánh giá, đính kèm hình ảnh minh họa và gửi đi chỉ với vài thao tác đơn giản. Ngoài việc phản ánh chất lượng và cảm nhận cá nhân, người dùng còn có thể trao đổi trực tiếp với Admin thông qua phần phản hồi đánh giá — nhận giải đáp thắc mắc, phản hồi nhanh chóng hoặc lời cảm ơn chân thành, giúp tạo nên sự gắn kết và tin tưởng.
b)	Admin quản lý đánh giá:
Ở phía Admin, toàn bộ đánh giá từ khách hàng sẽ được hệ thống tập hợp và hiển thị trong một giao diện quản lý thống nhất, với đầy đủ thông tin như tên người đánh giá, nội dung chi tiết, số sao, hình ảnh hoặc video đính kèm, cùng thời gian gửi và tình trạng phản hồi. Nhờ vậy, admin có thể dễ dàng nắm bắt tổng quan và chi tiết từng đánh giá chỉ trong một màn hình. Từ đây, Admin có thể chủ động phản hồi từng ý kiến, đưa ra lời giải thích rõ ràng, cảm ơn những phản hồi tích cực, xử lý nhanh các góp ý tiêu cực hoặc khiếu nại, và nếu cần, có thể ẩn hoặc điều chỉnh hiển thị những nội dung không phù hợp với tiêu chuẩn cộng đồng. Quá trình phản hồi được thực hiện ngay trên giao diện quản lý và được hệ thống đồng bộ thời gian thực, đồng thời thông báo sẽ được gửi đến khách hàng qua email hoặc tin nhắn để họ nắm được phản hồi mới nhất. Cách vận hành này giúp đảm bảo mọi đánh giá đều được xử lý minh bạch, nội dung phản hồi luôn kịp thời, qua đó củng cố hình ảnh thương hiệu thân thiện, chuyên nghiệp và luôn lắng nghe khách hàng. Không chỉ dừng ở việc quản lý phản hồi, hệ thống còn hỗ trợ thống kê, phân loại và phân tích xu hướng đánh giá theo thời gian, giúp Admin có thêm dữ liệu quan trọng để cải thiện sản phẩm, dịch vụ và trải nghiệm khách hàng một cách liên tục.
